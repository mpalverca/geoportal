<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Geovisor Multi-tabla Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 300;
    }

    .container {
      display: flex;
      height: calc(100vh - 100px);
      gap: 1rem;
      padding: 1rem;
    }

    .sidebar {
      width: 380px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .map-container {
      flex: 1;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    .status {
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .status.loading {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .data-count {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 500;
      color: #495057;
    }

    .table-info {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .table-info h4 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .table-info p {
      margin: 0.25rem 0;
      color: #6c757d;
    }

    .layer-controls {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .layer-controls h4 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      margin: 0.5rem 0;
    }

    .layer-toggle input[type="checkbox"] {
      margin-right: 0.5rem;
    }

    .popup-content {
      max-width: 280px;
    }

    .popup-content h4 {
      margin: 0 0 0.5rem 0;
      color: #2c3e50;
    }

    .popup-content p {
      margin: 0.25rem 0;
      font-size: 0.85rem;
    }

    .popup-content .label {
      font-weight: 500;
      color: #495057;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      max-width: 200px;
    }

    .legend h4 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
      font-size: 0.8rem;
    }

    .legend-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .legend-section {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .legend-section:last-child {
      border-bottom: none;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #2c3e50;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        height: auto;
      }

      .sidebar {
        width: 100%;
        order: 2;
      }

      .map-container {
        height: 400px;
        order: 1;
      }

      .legend {
        bottom: 10px;
        right: 10px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üó∫Ô∏è Geovisor de afectaciones Cant√≥n Loja- Coordinaci√≥n de Gesti√≥n de Riesgos-Ing Millan Paul Alverca Gaona</h1>
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Panel de Control</h3>
      </div>
      <div class="sidebar-content">
        <div id="status" class="status loading">üîé Conectando a la base de datos...</div>

        <div class="data-count">
          <div>Afectaciones : <span id="pointCount">0</span></div>
          <div>√Årea de influencia : <span id="polygonCount">0</span></div>
          <div>Damage Cooper: <span id="cooperCount">0</span></div>
        </div>

        <div class="layer-controls">
          <h4>Capas Visibles</h4>
          <div class="layer-toggle">
            <input type="checkbox" id="showPoints" checked>
            <label for="showPoints">Mostrar afectaciones </label>
          </div>
          <div class="layer-toggle">
            <input type="checkbox" id="showPolygons" checked>
            <label for="showPolygons">Mostrar √°reas de influencia</label>
          </div>
          <div class="layer-toggle">
            <input type="checkbox" id="showCooper" checked>
            <label for="showCooper">Mostrar Clasificaci√≥n de Da√±o (Cooper)</label>
          </div>
        </div>

        <div class="table-info">
          <h4>Informaci√≥n de las Tablas</h4>
          <p><strong>Afectaciones:</strong> Registros puntuales de gesti√≥n de riesgos</p>
          <p><strong>√Årea de influencia:</strong> Pol√≠gonos de √°reas afectadas</p>
          <p><strong>Puntos de Influencia:</strong> Pol√≠gonos de √°reas afectadas</p>
        </div>
      </div>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div class="legend">
        <div class="legend-section">
          <div class="legend-title">Afectaciones / Damage Cooper</div>
          <div class="legend-item">
            <div class="legend-icon" style="background-color: #dc3545; width: 16px; height: 16px; border-radius: 50%;"></div>
            <span>Prioridad Alta</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon" style="background-color: #ffc107; width: 16px; height: 16px; border-radius: 50%;"></div>
            <span>Prioridad Media</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon" style="background-color: #28a745; width: 16px; height: 16px; border-radius: 50%;"></div>
            <span>Prioridad Baja</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon" style="background-color: #007bff; width: 16px; height: 16px; border-radius: 50%;"></div>
            <span>Sin prioridad</span>
          </div>
        </div>
        <div class="legend-section">
          <div class="legend-title">√Årea de influencia</div>
          <div class="legend-item">
            <div class="legend-icon" style="background-color: rgba(255, 0, 0, 0.3); border: 2px solid #ff0000; width: 16px; height: 16px;"></div>
            <span>Influencia</span>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <script>
    // Configuraci√≥n Supabase
    const SUPABASE_URL = 'https://zpllugprxjqohnmxhizq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwbGx1Z3ByeGpxb2hubXhoaXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMjk0NTYsImV4cCI6MjA2NjkwNTQ1Nn0.wKZ1AgPUZMy178r75N2frJlJl6wbkrjCOk4m4MVqmEs';

    // Variables globales
    let map;
    let pointData = [];
    let polygonData = [];
    let cooperData=[];
    let markersLayer;
    let polygonsLayer;
    let cooperLayer;

    // Colores para marcadores seg√∫n prioridad
    const PRIORITY_COLORS = {
      'ALTA': '#dc3545',
      'MEDIA': '#ffc107',
      'BAJA': '#28a745',
      'DEFAULT': '#007bff'
    };

    // Colores para marcadores seg√∫n prioridad
    const DAMAGE_COOPER = {
      '7': '#dc3545',
      '6': '#dc3545',
      '5': '#dc3545',
      '4': '#ffc107',
      '3': '#ffc107',
      '2': '#28a745',      
      '1': '#28a745',
      'DEFAULT': '#007bff'
    };

    // Iconos por tipo de evento
    const EVENT_ICONS = {
      'Inundaci√≥n': { icon: 'water', color: '#1e90ff' },
      'Movimiento en masas': { icon: 'mountain', color: '#8b4513' },
      'Amenaza de colapso estructural': { icon: 'building', color: '#ff4500' },
      'Sismo': { icon: 'house-crack', color: '#9932cc' },
      'Incendio': { icon: 'fire', color: '#ff4500' },
      'DEFAULT': { icon: 'exclamation-triangle', color: '#007bff' }
    };

    // Iconos por tipo de afectaci√≥n
    const AFECTACION_ICONS = {
      'Vivienda': { icon: 'home', color: '#4169e1' },
      'Predio': { icon: 'map', color: '#a0522d' },
      '√Årea verde': { icon: 'tree', color: '#228b22' },
      'Vialidad': { icon: 'road', color: '#696969' },
      'Equipamiento': { icon: 'building', color: '#4682b4' },
      'DEFAULT': { icon: 'location-dot', color: '#007bff' }
    };

    // Funci√≥n para obtener el icono adecuado para puntos
    function getCustomIcon(item) {
      const evento = (item.EVENTO || '').toLowerCase();
      const afectacion = (item.AFECTACION || item.afectacion || '').toUpperCase().trim();
      const prioridad = (item.PRIORIDAD || '').toUpperCase().trim();

      // Buscar icono para el evento
      let iconInfo = EVENT_ICONS.DEFAULT;
      for (const [key, value] of Object.entries(EVENT_ICONS)) {
        if (evento.includes(key.toLowerCase())) {
          iconInfo = value;
          break;
        }
      }

      // Si no encontramos un icono espec√≠fico para el evento, probamos con la afectaci√≥n
      if (iconInfo === EVENT_ICONS.DEFAULT) {
        for (const [key, value] of Object.entries(AFECTACION_ICONS)) {
          if (afectacion.includes(key)) {
            iconInfo = value;
            break;
          }
        }
      }

      // Color seg√∫n prioridad
      const color = PRIORITY_COLORS[prioridad] || iconInfo.color || PRIORITY_COLORS.DEFAULT;

      return L.divIcon({
        className: 'custom-marker',
        html: `
          <div style="
            background-color: ${color};
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
          ">
            <i class="fas fa-${iconInfo.icon}"></i>
          </div>
        `,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
    }
    // Funci√≥n para obtener el icono adecuado para puntos
    function getCustomIconCooper(item) {
      const tipe= (item.tipe || '')
      const clase = (item.class ||'')
      const desc = (item.desc || '')

      // Buscar icono para el evento
      let iconInfo = { icon: 'home', color: '#1e90ff'};
      
      // Color seg√∫n prioridad
      const color = DAMAGE_COOPER[clase] || iconInfo.color || DAMAGE_COOPER.DEFAULT;

      return L.divIcon({
        className: 'custom-marker',
        html: `
          <div style="
            background-color: ${color};
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
          ">
            <i class="fas fa-${iconInfo.icon}"></i>
          </div>
        `,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
    }

    // Inicializar la aplicaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      initializeMap();
      cargarDatos();
      setupLayerControls();
    });

    function initializeMap() {
      // Inicializar mapa centrado en Loja, Ecuador
      map = L.map('map').setView([-3.9939, -79.2042], 12);

      // Agregar capa base
      L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '¬© Google Satellite'
      }).addTo(map);

      // Inicializar capas
      markersLayer = L.layerGroup().addTo(map);
      polygonsLayer = L.layerGroup().addTo(map);
      cooperLayer= L.layerGroup().addTo(map);
    }

    function setupLayerControls() {
      const showPointsCheckbox = document.getElementById('showPoints');
      const showPolygonsCheckbox = document.getElementById('showPolygons');
      const showCooperCheckbox = document.getElementById('showCooper')

      showPointsCheckbox.addEventListener('change', () => {
        if (showPointsCheckbox.checked) {
          map.addLayer(markersLayer);
        } else {
          map.removeLayer(markersLayer);
        }
      });

      showPolygonsCheckbox.addEventListener('change', () => {
        if (showPolygonsCheckbox.checked) {
          map.addLayer(polygonsLayer);
        } else {
          map.removeLayer(polygonsLayer);
        }
      });
      showCooperCheckbox.addEventListener('change', () => {
        if (showCooperCheckbox.checked) {
          map.addLayer(cooperLayer);
        } else {
          map.removeLayer(cooperLayer);
        }
      });
    }

    async function cargarDatos() {
      const status = document.getElementById('status');

      try {
        status.textContent = 'üîÑ Cargando datos de ambas tablas...';
        status.className = 'status loading';

        // Cargar datos de puntos (bd_loja_1)
        const pointResponse = await fetch(`${SUPABASE_URL}/rest/v1/bd_loja_1?select=*`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        // Cargar datos de pol√≠gonos (pol_afect)
        const polygonResponse = await fetch(`${SUPABASE_URL}/rest/v1/pol_afect?select=*`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        // Cargar datos de pol√≠gonos (pol_afect)
        const cooperResponse = await fetch(`${SUPABASE_URL}/rest/v1/damage_cooper?select=*`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!pointResponse.ok || !polygonResponse.ok || !cooperResponse.ok) {
          throw new Error('Error al cargar datos de las tablas');
        }

        pointData = await pointResponse.json();
        polygonData = await polygonResponse.json();
        cooperData = await cooperResponse.json();

        // Mostrar datos en el mapa
        mostrarPuntosEnMapa();
        mostrarPoligonosEnMapa();
        mostrarCooperEnMapa();

        // Actualizar contadores
        actualizarContadores();

        // Ajustar vista del mapa
        ajustarVistaMapa();

        status.textContent = `‚úÖ Datos cargados: ${pointData.length} afectacones, ${polygonData.length} √°reas de influencia, ${cooperData.length} puntos de control.`;
        status.className = 'status success';

      } catch (error) {
        console.error('Error al cargar datos:', error);
        status.textContent = `‚ùå Error: ${error.message}`;
        status.className = 'status error';
      }
    }

    function mostrarPuntosEnMapa() {
      // Limpiar marcadores anteriores
      markersLayer.clearLayers();

      // Agregar marcadores para datos que tengan coordenadas
      pointData.forEach(item => {
        let lat, lng;

        // Intentar obtener coordenadas de diferentes campos posibles
        if (item.geom && item.geom.coordinates) {
          // Formato GeoJSON
          lng = parseFloat(item.geom.coordinates[0]);
          lat = parseFloat(item.geom.coordinates[1]);
        } else {
          // Campos individuales
          lat = parseFloat(item.LATITUD || item.lat || item.latitude);
          lng = parseFloat(item.LONGITUD || item.lng || item.longitude);
        }

        // Verificar que las coordenadas sean v√°lidas para el √°rea de Loja
        if (isNaN(lat) || isNaN(lng) || lat < -4.5 || lat > -3.5 || lng < -80.5 || lng > -78.5) {
          // Generar coordenadas aleatorias dentro del √°rea de Loja
          lat = -3.9939 + (Math.random() * 0.4 - 0.2);
          lng = -79.2042 + (Math.random() * 0.4 - 0.2);
        }

        // Crear marcador con icono personalizado
        const marker = L.marker([lat, lng], {
          icon: getCustomIcon(item)
        });

        // Crear popup con informaci√≥n
        const popupContent = crearPopupContentPuntos(item, lat, lng);
        marker.bindPopup(popupContent);

        // Agregar marcador a la capa
        markersLayer.addLayer(marker);
      });
    }

    function mostrarPoligonosEnMapa() {
      // Limpiar pol√≠gonos anteriores
      polygonsLayer.clearLayers();

      // Agregar pol√≠gonos
      polygonData.forEach(item => {
        let polygon;

        if (item.geom && item.geom.coordinates) {
          // Datos GeoJSON
          const coordinates = item.geom.coordinates;
          
          if (item.geom.type === 'Polygon') {
            // Convertir coordenadas GeoJSON a formato Leaflet
            const leafletCoords = coordinates[0].map(coord => [coord[1], coord[0]]);
            polygon = L.polygon(leafletCoords, {
              color: '#ff0000',
              fillColor: '#ff0000',
              fillOpacity: 0.3,
              weight: 2
            });
          } else if (item.geom.type === 'MultiPolygon') {
            // Manejar MultiPolygon
            const leafletCoords = coordinates.map(poly => 
              poly[0].map(coord => [coord[1], coord[0]])
            );
            polygon = L.polygon(leafletCoords, {
              color: '#ff0000',
              fillColor: '#ff0000',
              fillOpacity: 0.3,
              weight: 2
            });
          }
        } else {
          // Si no hay geometr√≠a v√°lida, crear un pol√≠gono de ejemplo en Loja
          const centerLat = -3.9939 + (Math.random() * 0.2 - 0.1);
          const centerLng = -79.2042 + (Math.random() * 0.2 - 0.1);
          const size = 0.005; // Tama√±o del pol√≠gono

          polygon = L.polygon([
            [centerLat - size, centerLng - size],
            [centerLat - size, centerLng + size],
            [centerLat + size, centerLng + size],
            [centerLat + size, centerLng - size]
          ], {
            color: '#ff0000',
            fillColor: '#ff0000',
            fillOpacity: 0.3,
            weight: 2
          });
        }

        if (polygon) {
          // Crear popup con informaci√≥n
          const popupContent = crearPopupContentPoligonos(item);
          polygon.bindPopup(popupContent);

          // Agregar pol√≠gono a la capa
          polygonsLayer.addLayer(polygon);
        }
      });
    }

    function mostrarCooperEnMapa() {
      // Limpiar marcadores anteriores
      cooperLayer.clearLayers();

      // Agregar marcadores para datos que tengan coordenadas
      cooperData.forEach(item => {
        let lat, lng;

        // Intentar obtener coordenadas de diferentes campos posibles
        if (item.geom && item.geom.coordinates) {
          // Formato GeoJSON
          lng = parseFloat(item.geom.coordinates[0]);
          lat = parseFloat(item.geom.coordinates[1]);
        } else {
          // Campos individuales
          lat = parseFloat(item.LATITUD || item.lat || item.latitude);
          lng = parseFloat(item.LONGITUD || item.lng || item.longitude);
        }

        // Verificar que las coordenadas sean v√°lidas para el √°rea de Loja
        if (isNaN(lat) || isNaN(lng) || lat < -4.5 || lat > -3.5 || lng < -80.5 || lng > -78.5) {
          // Generar coordenadas aleatorias dentro del √°rea de Loja
          lat = -3.9939 + (Math.random() * 0.4 - 0.2);
          lng = -79.2042 + (Math.random() * 0.4 - 0.2);
        }

        // Crear marcador con icono personalizado
        const marker = L.marker([lat, lng], {
          icon: getCustomIconCooper(item)
        });

        // Crear popup con informaci√≥n
        const popupContent = crearPopupContentCooper(item, lat, lng);
        marker.bindPopup(popupContent);

        // Agregar marcador a la capa
        cooperLayer.addLayer(marker);
      });
    }

    function crearPopupContentPuntos(item, lat, lng) {
      const formatCoords = (coord) => {
        return coord.toFixed(6);
      };

      let content = `<div class="popup-content">`;
      
      // T√≠tulo
      const titulo = item.EVENTO || item.id || 'Registro de Punto';
      content += `<h4>${titulo} - ${item.id} </h4>`;
      
      // Mostrar campos principales
      const camposPrincipales = ['FECHA', 'ANIO', 'SECTOR_BASICO', 'AFECTACION', 'ESTADO', 'PRIORIDAD'];
      
      camposPrincipales.forEach(campo => {
        if (item[campo]) {
          let valor = item[campo];
          if (campo === 'FECHA') {
            valor = new Date(valor).toLocaleDateString();
          }
          content += `<p><span class="label">${formatFieldName(campo)}:</span> ${valor}</p>`;
        }
      });

      // Coordenadas
      content += `<p><span class="label">Coordenadas:</span><br>${formatCoords(lat)}, ${formatCoords(lng)}</p>`;

      // Descripci√≥n si existe
      if (item.descripcion) {
        const desc = item.descripcion.length > 100 ? 
          item.descripcion.substring(0, 100) + '...' : 
          item.descripcion;
        content += `<p><span class="label">Descripci√≥n:</span> ${desc}</p>`;
      }

      content += `</div>`;
      return content;
    }

    function crearPopupContentPoligonos(item) {
      let content = `<div class="popup-content">`;
      
      // T√≠tulo
      const titulo = item.tipo || item.desc || item.id || 'Pol√≠gono de Afectaci√≥n';
      content += `<h4>${titulo}</h4>`;
      
      // Mostrar campos disponibles
      const campos = ['id', 'tipo', 'desc', 'fid'];
      
      campos.forEach(campo => {
        if (item[campo]) {
          let valor = item[campo];
          let label = formatFieldName(campo);
          content += `<p><span class="label">${label}:</span> ${valor}</p>`;
        }
      });

      // Informaci√≥n adicional
      content += `<p><span class="label">Tipo:</span> Pol√≠gono de √°rea afectada</p>`;

      content += `</div>`;
      return content;
    }

    function crearPopupContentCooper(item, lat, lng) {
      const formatCoords = (coord) => {
        return coord.toFixed(6);
      };

      let content = `<div class="popup-content">`;
      
      // T√≠tulo
      const titulo = item.EVENTO || `clase ${item.class}` || 'Registro de Punto';
      content += `<h4>${titulo} -${item.id} </h4>`;
      
      // Mostrar campos principales
      const camposPrincipales = ['FECHA', 'Class', 'tipe', 'desc'];
      
      camposPrincipales.forEach(campo => {
        if (item[campo]) {
          let valor = item[campo];
          if (campo === 'FECHA') {
            valor = new Date(valor).toLocaleDateString();
          }
          content += `<p><span class="label">${formatFieldName(campo)}:</span> ${valor}</p>`;
        }
      });

      // Coordenadas
      content += `<p><span class="label">Coordenadas:</span><br>${formatCoords(lat)}, ${formatCoords(lng)}</p>`;

      // Descripci√≥n si existe
      if (item.descripcion) {
        const desc = item.descripcion.length > 100 ? 
          item.descripcion.substring(0, 100) + '...' : 
          item.descripcion;
        content += `<p><span class="label">Descripci√≥n:</span> ${desc}</p>`;
      }

      content += `</div>`;
      return content;
    }

    function formatFieldName(field) {
      const fieldNames = {
        'ANIO': 'A√±o',
        'SECTOR_BASICO': 'Sector',
        'EVENTO': 'Tipo de Evento',
        'AFECTACION': 'Afectaci√≥n',
        'ESTADO': 'Estado',
        'PRIORIDAD': 'Prioridad',
        'FECHA': 'Fecha',
        'id': 'ID',
        'tipo': 'Tipo',
        'desc': 'Descripci√≥n',
        'fid': 'ID √önico'
      };
      return fieldNames[field] || field;
    }

    function actualizarContadores() {
      document.getElementById('pointCount').textContent = pointData.length;
      document.getElementById('polygonCount').textContent = polygonData.length;
      document.getElementById('cooperCount').textContent = cooperData.length;
    }

    function ajustarVistaMapa() {
      const allLayers = [];
      
      // Agregar todas las capas para calcular bounds
      markersLayer.eachLayer(layer => allLayers.push(layer));
      polygonsLayer.eachLayer(layer => allLayers.push(layer));      
      cooperLayer.eachLayer(layer => allLayers.push(layer));

      if (allLayers.length > 0) {
        const group = new L.featureGroup(allLayers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
  </script>
</body>
</html>
